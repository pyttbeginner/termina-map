// ============================================
// КОНФИГУРАЦИЯ ЗОН
// Отредактируй этот массив или используй визуальный редактор (клавиша E)
// ============================================
let worldZones = [
    {
        "id": "prehevil___eastern_outskirts2",
        "name": "Prehevil_-_Eastern_Outskirts2",
        "x": 886,
        "y": 320,
        "width": 105,
        "height": 70,
        "outdoor": "Prehevil_-_Eastern_Outskirts2.png"
    },
    {
        "id": "prehevil___temple_site__28museum_292",
        "name": "Prehevil_-_Temple_Site_Museum2",
        "x": 563,
        "y": 126,
        "width": 65,
        "height": 89,
        "outdoor": "Prehevil_-_Temple_Site_Museum2.png"
    },
    {
        "id": "prehevil___west__28back_area_292",
        "name": "Prehevil_-_West_Back_Area2",
        "x": 94,
        "y": 160,
        "width": 130,
        "height": 100,
        "outdoor": "Prehevil_-_West_Back_Area2.png"
    },
    {
        "id": "old_town___slums2",
        "name": "Old_Town_-_Slums2",
        "x": 774,
        "y": 470,
        "width": 87,
        "height": 62,
        "outdoor": "Old_Town_-_Slums2.png"
    },
    {
        "id": "lake",
        "name": "Lake",
        "x": 861,
        "y": 483,
        "width": 100,
        "height": 135,
        "outdoor": "Lake2.png"
    },
    {
        "id": "maiden_forest2",
        "name": "Maiden_Forest2",
        "x": 356,
        "y": 469,
        "width": 130,
        "height": 124,
        "outdoor": "Maiden_Forest2.png"
    },
    {
        "id": "outskirts_of_prehevil___train",
        "name": "Outskirts_of_Prehevil_-_Train",
        "x": 567,
        "y": 649,
        "width": 225,
        "height": 144,
        "outdoor": "Outskirts_of_Prehevil_-_Train3.png"
    },
    {
        "id": "prehevil___west__28news_agency_292",
        "name": "Prehevil_-_West_News_Agency2",
        "x": 232,
        "y": 186,
        "width": 107,
        "height": 114,
        "outdoor": "Prehevil_-_West_News_Agency2.png"
    },
    {
        "id": "island",
        "name": "Island",
        "x": 1060,
        "y": 472,
        "width": 59,
        "height": 63,
        "outdoor": "Island.png"
    },
    {
        "id": "path_to_river2",
        "name": "Path_to_River2",
        "x": 701,
        "y": 620,
        "width": 139,
        "height": 84,
        "outdoor": "Path_to_River2.png"
    },
    {
        "id": "riverside2",
        "name": "Riverside2",
        "x": 809,
        "y": 551,
        "width": 47,
        "height": 136,
        "outdoor": "Riverside2.png"
    },
    {
        "id": "deep_woods5",
        "name": "Deep_Woods5",
        "x": 182,
        "y": 562,
        "width": 146,
        "height": 109,
        "outdoor": "Deeper_Woods5.png"
    },
    {
        "id": "deep_woods2",
        "name": "Deep_Woods2",
        "x": 222,
        "y": 427,
        "width": 133,
        "height": 93,
        "outdoor": "Deep_Woods2.png"
    },
    {
        "id": "prehevil___ruined_streets2",
        "name": "Prehevil_-_Ruined_Streets2",
        "x": 229,
        "y": 303,
        "width": 94,
        "height": 107,
        "outdoor": "Prehevil_-_Ruined_Streets2.png"
    },
    {
        "id": "mausoleum_alley2",
        "name": "Mausoleum_Alley2",
        "x": 764,
        "y": 222,
        "width": 85,
        "height": 57,
        "outdoor": "Mausoleum_Alley2.png"
    },
    {
        "id": "old_town___gate2",
        "name": "Old_Town_-_Gate2",
        "x": 493,
        "y": 436,
        "width": 138,
        "height": 103,
        "outdoor": "Old_Town_-_Gate2.png"
    },
    {
        "id": "old_town___mayor_27s_manor2",
        "name": "Old_Town_-_Mayors_Manor2",
        "x": 634,
        "y": 413,
        "width": 142,
        "height": 148,
        "outdoor": "Old_Town_-_Mayors_Manor2.png"
    },
    {
        "id": "outskirts_of_prehevil___abandoned_house2",
        "name": "Outskirts_of_Prehevil_-_Abandoned_House2",
        "x": 484,
        "y": 554,
        "width": 134,
        "height": 74,
        "outdoor": "Outskirts_of_Prehevil_-_Abandoned_House2.png"
    },
    {
        "id": "prehevil___staircase2",
        "name": "Prehevil_-_Staircase2",
        "x": 527,
        "y": 288,
        "width": 82,
        "height": 137,
        "outdoor": "Prehevil_-_Staircase2.png"
    },
    {
        "id": "outskirts_of_prehevil___broken_shack2",
        "name": "Outskirts_of_Prehevil_-_Broken_Shack2",
        "x": 465,
        "y": 640,
        "width": 102,
        "height": 72,
        "outdoor": "Outskirts_of_Prehevil_-_Broken_Shack2.png"
    },
    {
        "id": "deepest_woods2",
        "name": "Deepest_Woods2",
        "x": 107,
        "y": 436,
        "width": 116,
        "height": 111,
        "outdoor": "Deepest_Woods2.png"
    },
    {
        "id": "hidden_spot2",
        "name": "Hidden_Spot2",
        "x": 119,
        "y": 562,
        "width": 59,
        "height": 54,
        "outdoor": "Hidden_Spot2.png"
    },
    {
        "id": "prehevil___north_west2",
        "name": "Prehevil_-_North-West2",
        "x": 261,
        "y": 86,
        "width": 150,
        "height": 72,
        "outdoor": "Prehevil_-_North-West2.png"
    },
    {
        "id": "prehevil___temple_site__28hollow_tower_292",
        "name": "Prehevil_-_Temple_Site_Hollow_Tower2",
        "x": 629,
        "y": 114,
        "width": 150,
        "height": 120,
        "outdoor": "Prehevil_-_Temple_Site_Hollow_Tower2.png"
    },
    {
        "id": "prehevil___central2",
        "name": "Prehevil_-_Central2",
        "x": 606,
        "y": 302,
        "width": 179,
        "height": 85,
        "outdoor": "Prehevil_-_Central2.png"
    },
    {
        "id": "prehevil___shopping_street2",
        "name": "Prehevil_-_Shopping_Street2",
        "x": 398,
        "y": 199,
        "width": 146,
        "height": 71,
        "outdoor": "Prehevil_-_Shopping_Street2.png"
    },
    {
        "id": "prehevil___east2",
        "name": "Prehevil_-_East2",
        "x": 785,
        "y": 303,
        "width": 102,
        "height": 84,
        "outdoor": "Prehevil_-_East2.png"
    },
    {
        "id": "prehevil___back_alleys__28sylvian_27s_square_292",
        "name": "Prehevil_-_Back_Alleys_Sylvians_Square2",
        "x": 322,
        "y": 283,
        "width": 104,
        "height": 122,
        "outdoor": "Prehevil_-_Back_Alleys_Sylvians_Square2.png"
    },
    {
        "id": "prehevil___back_alleys2",
        "name": "Prehevil_-_Back_Alleys2",
        "x": 421,
        "y": 285,
        "width": 108,
        "height": 108,
        "outdoor": "Prehevil_-_Back_Alleys2.png"
    }
];

// ============================================
// КОНФИГУРАЦИЯ ЗДАНИЙ
// ============================================
const buildings = {
    'tavern': {
        name: 'Таверна (PRHVL Bop)',
        indoorMaps: ['PRHVL_Bop3.jpg', 'PRHVL_Bop4.jpg']
    },
    'church': {
        name: 'Церковь Вселл-мер',
        indoorMaps: [
            'Church_of_Alll-mer3.jpg',
            'Church_of_Alll-mer4.jpg',
            'Church_of_Alll-mer5.jpg',
            'Church_of_Alll-mer6.jpg',
            'Church_of_Alll-mer7.jpg',
            'Church_of_Alll-mer8.jpg',
            'Church_of_Alll-mer9.jpg',
            'Church_of_Alll-mer10.jpg'
        ]
    },
    'department_store': {
        name: 'Универмаг',
        indoorMaps: [
            'Department_Store3.jpg',
            'Department_Store4.jpg',
            'Department_Store5.jpg',
            'Department_Store6.jpg',
            'Department_Store7.jpg',
            'Department_Store8.jpg'
        ]
    },
    'museum': {
        name: 'Музей',
        indoorMaps: ['Museum3.jpg', 'Museum4.jpg']
    },
    'mayors_manor': {
        name: 'Особняк мэра',
        indoorMaps: [
            'Mayors_Manor3.jpg',
            'Mayors_Manor4.jpg',
            'Mayors_Manor5.jpg'
        ]
    },
    'orphanage': {
        name: 'Приют',
        indoorMaps: [
            'Orphanage3.jpg',
            'Orphanage4.jpg',
            'Orphanage5.jpg',
            'Orphanage6.jpg',
            'Orphanage7.jpg',
            'Orphanage8.jpg'
        ]
    },
    'white_mold_apartments': {
        name: 'Апартаменты "Белая плесень"',
        indoorMaps: [
            'White_Mold_Apartments3.jpg',
            'White_Mold_Apartments4.jpg',
            'White_Mold_Apartments5.jpg',
            'White_Mold_Apartments6.jpg'
        ]
    },
    'abandoned_house': {
        name: 'Заброшенный дом',
        indoorMaps: [
            'Abandoned_House2.jpg',
            'Abandoned_House3.jpg',
            'Abandoned_House4.jpg'
        ]
    },
    'book_store': {
        name: 'Книжный магазин',
        indoorMaps: ['Book_Store3.jpg', 'Book_Store4.jpg']
    },
    'clothing_store': {
        name: 'Магазин одежды',
        indoorMaps: ['Clothing_Store3.jpg']
    },
    'news_agency': {
        name: 'Новостное агентство',
        indoorMaps: ['News_Agency3.jpg', 'News_Agency4.jpg', 'News_Agency5.jpg']
    },
    'old_hotel': {
        name: 'Старый отель',
        indoorMaps: ['Old_Hotel3.jpg', 'Old_Hotel4.jpg']
    },
    'renka_cafe': {
        name: 'Кафе Ренка',
        indoorMaps: ['Renka_Cafe3.jpg']
    },
    'restaurant': {
        name: 'Ресторан "Белый Волк"',
        indoorMaps: ['Restaurant_Bily_Vol3.jpg', 'Restaurant_Bily_Vol4.jpg']
    },
    'small_hut_shop': {
        name: 'Лавка',
        indoorMaps: ['Small_Hut_-_Shop3.jpg']
    },
    'crypt': {
        name: 'Склеп',
        indoorMaps: ['Crypt3.jpg', 'Crypt4.jpg']
    },
    'sewers': {
        name: 'Канализация',
        indoorMaps: [
            'Sewers_-_West_Junction2.jpg',
            'Sewers_-_Backrooms2.jpg',
            'Sewers_-_Mid_Tunnels2.jpg',
            'Sewers_-_Southern_Tunnels3.jpg',
            'Sewers_-_Western_End2.jpg',
            'Sewers_-_Western_Tunnels4.jpg',
            'Sewers_-_Western_Tunnels7.jpg'
        ]
    },
    'sewage_treatment': {
        name: 'Очистные сооружения',
        indoorMaps: [
            'Sewage_Treatment_Plant2.jpg',
            'Sewage_Treatment_Plant3.jpg',
            'Sewage_Treatment_Plant4.jpg'
        ]
    },
    'train': {
        name: 'Поезд',
        indoorMaps: ['Train2.jpg', 'Train3.jpg']
    },
    'tunnel_1': {
        name: 'Тоннель 1',
        indoorMaps: ['Tunnel_1_3.jpg', 'Tunnel_1_4.jpg', 'Tunnel_1_5.jpg', 'Tunnel_1_6.jpg']
    },
    'tunnel_4': {
        name: 'Тоннель 4',
        indoorMaps: ['Tunnel_4_2.jpg', 'Tunnel_4_3.jpg', 'Tunnel_4_4.jpg']
    },
    'tunnel_5': {
        name: 'Тоннель 5',
        indoorMaps: ['Tunnel_5_2.jpg']
    },
    'tunnel_6': {
        name: 'Тоннель 6',
        indoorMaps: ['Tunnel_6_2.jpg']
    },
    'tunnel_7': {
        name: 'Тоннель 7',
        indoorMaps: ['Tunnel_7_2.jpg', 'Tunnel_7_3.jpg']
    },
    'white_bunker': {
        name: 'Белый бункер',
        indoorMaps: [
            'White_Bunker2.jpg',
            'White_Bunker3.jpg',
            'White_Bunker4.jpg',
            'White_Bunker5.jpg',
            'White_Bunker6.jpg',
            'White_Bunker7.jpg'
        ]
    },
    'old_apartments_back': {
        name: 'Старые апартаменты (Задние переулки)',
        indoorMaps: ['Old_Apartments_-_Back_Alleys3.jpg', 'Old_Apartments_-_Back_Alleys4.jpg']
    },
    'old_apartments_northwest': {
        name: 'Старые апартаменты (Северо-запад)',
        indoorMaps: ['Old_Apartments_-_North-West3.jpg', 'Old_Apartments_-_North-West4.jpg', 'Old_Apartments_-_North-West5.jpg']
    },
    'two_story_house': {
        name: 'Двухэтажный дом',
        indoorMaps: ['Two-story_House3.jpg', 'Two-story_House4.jpg', 'Two-story_House5.jpg']
    },
    'old_house': {
        name: 'Старый дом',
        indoorMaps: ['Old_House3.jpg', 'Old_House4.jpg']
    },
    'derelict_house': {
        name: 'Разрушенный дом',
        indoorMaps: ['Derelict_House3.jpg']
    },
    'deserted_cottage': {
        name: 'Заброшенная хижина',
        indoorMaps: ['Deserted_Cottage3.jpg']
    },
    'filthy_shack_slums': {
        name: 'Грязная хижина (Трущобы)',
        indoorMaps: ['Filthy_Shack_-_Slums3.jpg']
    },
    'filthy_shack_lake': {
        name: 'Грязная хижина (Озеро)',
        indoorMaps: ['Filthy_Shack_-_Lake3.jpg']
    },
    'filthy_shack_eastern': {
        name: 'Грязная хижина (Восточная окраина)',
        indoorMaps: ['Filthy_Shack_-_Eastern_Outskirts3.jpg']
    },
    'donnovans_house': {
        name: 'Дом Доннована',
        indoorMaps: ['Donnovans_House3.jpg']
    },
    'dr_kefer': {
        name: 'Трюки и магия д-ра Кефера',
        indoorMaps: ['Dr._Kefer%27s_Tricks_%26_Magic3.jpg', 'Dr._Kefer%27s_Tricks_%26_Magic4.jpg']
    },
    'altar_of_one_god': {
        name: 'Алтарь Единого Бога',
        indoorMaps: ['Altar_of_the_One_God3.jpg']
    },
    'golden_gates': {
        name: 'Золотые врата',
        indoorMaps: [
            'Golden_Gates2.jpg',
            'Golden_Gates3.jpg',
            'Golden_Gates4.jpg',
            'Golden_Gates5.jpg',
            'Golden_Gates6.jpg',
            'Golden_Gates7.jpg',
            'Golden_Gates8.jpg'
        ]
    },
    'inner_garden': {
        name: 'Внутренний сад',
        indoorMaps: ['Inner_Garden3.jpg', 'Inner_Garden4.jpg']
    },
    'old_storage': {
        name: 'Старый склад',
        indoorMaps: ['Old_Storage3.jpg']
    },
    'foundations_of_decay': {
        name: 'Основы упадка',
        indoorMaps: ['Foundations_of_Decay2.jpg', 'Foundations_of_Decay3.jpg', 'Foundations_of_Decay4.jpg']
    },
    'waste_disposal': {
        name: 'Офис утилизации отходов',
        indoorMaps: ['Waste_Disposal_Office3.jpg']
    },
    'small_hut_toilet': {
        name: 'Туалет',
        indoorMaps: ['Small_Hut_-_Toilet3.jpg', 'Small_Hut_-_Toilet4.jpg']
    },
    'well': {
        name: 'Колодец',
        indoorMaps: ['Well3.jpg']
    },
    'tent': {
        name: 'Палатка',
        indoorMaps: ['Tent3.jpg']
    }
};

// ============================================
// СПИСОК ЗДАНИЙ
// ============================================
// Категории зданий для фильтра
const buildingCategories = {
    'shop': ['tavern', 'department_store', 'book_store', 'clothing_store', 'renka_cafe', 'restaurant', 'small_hut_shop', 'news_agency', 'dr_kefer'],
    'residential': ['mayors_manor', 'orphanage', 'white_mold_apartments', 'abandoned_house', 'old_hotel', 'old_apartments_back', 'old_apartments_northwest', 'two_story_house', 'old_house', 'derelict_house', 'deserted_cottage', 'filthy_shack_slums', 'filthy_shack_lake', 'filthy_shack_eastern', 'donnovans_house', 'white_bunker'],
    'special': ['church', 'museum', 'crypt', 'altar_of_one_god', 'golden_gates', 'inner_garden', 'old_storage', 'foundations_of_decay', 'waste_disposal', 'small_hut_toilet', 'well', 'tent'],
    'sewers': ['sewers', 'sewage_treatment'],
    'tunnels': ['tunnel_1', 'tunnel_4', 'tunnel_5', 'tunnel_6', 'tunnel_7'],
    'transport': ['train']
};

// ============================================
// ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
// ============================================
let markersData = null;
let currentOutdoorMap = null;
let editorMode = false;
let draggedZone = null;
let resizedZone = null;
let dragOffsetX = 0;
let dragOffsetY = 0;
let zoneCounter = 0;

// Режим добавления меток
let markerEditMode = false;
let currentMarkerType = null; // 'building', 'enemy', 'chest', 'bed'
let pendingMarkerData = null;

// ============================================
// ИНИЦИАЛИЗАЦИЯ
// ============================================
document.addEventListener('DOMContentLoaded', async () => {
    await loadMarkers();
    renderWorldZones();
    setupEditorControls();
    setupMarkerControls();
});

// ============================================
// ЗАГРУЗКА МЕТОК
// ============================================
async function loadMarkers() {
    try {
        const response = await fetch('data/markers.json');
        markersData = await response.json();
        console.log('Метки загружены:', markersData);
    } catch (error) {
        console.error('Ошибка загрузки markers.json:', error);
        markersData = { enemies: [], chests: [], beds: [], buildings: [] };
    }
}

// ============================================
// ОТРИСОВКА ЗОН
// ============================================
function renderWorldZones() {
    const overlay = document.getElementById('overlay-layer');
    if (!overlay) {
        console.error('overlay-layer не найден');
        return;
    }
    
    overlay.innerHTML = '';

    worldZones.forEach((zone, index) => {
        const zoneEl = document.createElement('div');
        zoneEl.className = 'clickable-zone' + (editorMode ? ' editor-mode' : '');
        zoneEl.style.left = zone.x + 'px';
        zoneEl.style.top = zone.y + 'px';
        zoneEl.style.width = zone.width + 'px';
        zoneEl.style.height = zone.height + 'px';
        zoneEl.dataset.index = index;

        if (editorMode) {
            // В режиме редактора: перетаскивание и ресайз
            setupZoneDrag(zoneEl, zone);
            setupZoneResize(zoneEl, zone);

            // Добавляем метку с названием
            const label = document.createElement('div');
            label.className = 'zone-label';
            label.textContent = zone.name || `Зона ${index + 1}`;
            zoneEl.appendChild(label);
        } else {
            // В обычном режиме: клик для открытия карты + превью
            zoneEl.title = zone.name || `Зона ${index + 1}`;
            zoneEl.addEventListener('click', () => openOutdoorModal(zone));
            
            // Добавляем превью изображения
            if (zone.outdoor) {
                const img = document.createElement('img');
                img.src = `maps_outdor/${zone.outdoor}`;
                img.alt = zone.name || `Зона ${index + 1}`;
                img.className = 'zone-preview';
                zoneEl.appendChild(img);
            }
        }

        overlay.appendChild(zoneEl);
    });
    
    console.log(`Зоны отрисованы: ${worldZones.length} шт.`);
}

// ============================================
// РЕДАКТОР: ПЕРЕТАСКИВАНИЕ
// ============================================
function setupZoneDrag(zoneEl, zone) {
    zoneEl.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('resize-handle')) return;
        
        draggedZone = zone;
        const rect = zoneEl.getBoundingClientRect();
        const mapRect = document.getElementById('world-map').getBoundingClientRect();
        
        dragOffsetX = e.clientX - rect.left;
        dragOffsetY = e.clientY - rect.top;

        document.addEventListener('mousemove', onDrag);
        document.addEventListener('mouseup', stopDrag);
    });
}

function onDrag(e) {
    if (!draggedZone) return;

    const mapImg = document.getElementById('world-map');
    const mapRect = mapImg.getBoundingClientRect();
    
    let newX = e.clientX - mapRect.left - dragOffsetX;
    let newY = e.clientY - mapRect.top - dragOffsetY;

    // Ограничиваем границами карты
    newX = Math.max(0, Math.min(newX, mapRect.width - draggedZone.width));
    newY = Math.max(0, Math.min(newY, mapRect.height - draggedZone.height));

    draggedZone.x = Math.round(newX);
    draggedZone.y = Math.round(newY);

    renderWorldZones();
}

function stopDrag() {
    draggedZone = null;
    document.removeEventListener('mousemove', onDrag);
    document.removeEventListener('mouseup', stopDrag);
}

// ============================================
// РЕДАКТОР: ИЗМЕНЕНИЕ РАЗМЕРА
// ============================================
function setupZoneResize(zoneEl, zone) {
    const handle = document.createElement('div');
    handle.className = 'resize-handle';
    zoneEl.appendChild(handle);

    handle.addEventListener('mousedown', (e) => {
        e.stopPropagation();
        resizedZone = zone;
        
        document.addEventListener('mousemove', onResize);
        document.addEventListener('mouseup', stopResize);
    });
}

function onResize(e) {
    if (!resizedZone) return;

    const mapImg = document.getElementById('world-map');
    const mapRect = mapImg.getBoundingClientRect();

    let newWidth = e.clientX - mapRect.left - resizedZone.x;
    let newHeight = e.clientY - mapRect.top - resizedZone.y;

    // Минимальный размер
    newWidth = Math.max(30, newWidth);
    newHeight = Math.max(30, newHeight);

    // Максимальный размер
    newWidth = Math.min(newWidth, mapRect.width - resizedZone.x);
    newHeight = Math.min(newHeight, mapRect.height - resizedZone.y);

    resizedZone.width = Math.round(newWidth);
    resizedZone.height = Math.round(newHeight);

    renderWorldZones();
}

function stopResize() {
    resizedZone = null;
    document.removeEventListener('mousemove', onResize);
    document.removeEventListener('mouseup', stopResize);
}

// ============================================
// РЕДАКТОР: УПРАВЛЕНИЕ
// ============================================
function setupEditorControls() {
    // Кнопка включения/выключения редактора
    document.getElementById('toggle-editor-btn').addEventListener('click', toggleEditorMode);

    // Кнопка добавления зоны
    document.getElementById('add-zone-btn').addEventListener('click', addNewZone);

    // Кнопка экспорта
    document.getElementById('export-zones-btn').addEventListener('click', exportZones);

    // Форма редактирования зоны
    document.getElementById('zone-edit-form').addEventListener('submit', saveZoneEdit);

    // Кнопка удаления зоны
    document.getElementById('delete-zone-btn').addEventListener('click', deleteZone);
}

// Клавиша E для переключения редактора (глобально)
document.addEventListener('keydown', (e) => {
    if (e.key === 'e' || e.key === 'E' || e.key === 'у' || e.key === 'У') {
        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
            toggleEditorMode();
        }
    }
});

function toggleEditorMode() {
    editorMode = !editorMode;

    const editorPanel = document.getElementById('editor-panel');
    if (editorPanel) {
        editorPanel.classList.toggle('hidden', !editorMode);
    }

    renderWorldZones();

    console.log('Режим редактора:', editorMode ? 'ВКЛ' : 'ВЫКЛ');
}

function addNewZone() {
    const newZone = {
        id: 'zone_' + (++zoneCounter),
        name: 'New_Zone_' + (worldZones.length + 1),
        x: 50 + (worldZones.length * 20),
        y: 50 + (worldZones.length * 20),
        width: 150,
        height: 120,
        outdoor: ''
    };
    
    worldZones.push(newZone);
    renderWorldZones();
    
    // Открываем форму редактирования для новой зоны
    openZoneEditModal(worldZones.length - 1);
}

function exportZones() {
    // Очищаем id перед экспортом (генерируются автоматически)
    const zonesToExport = worldZones.map((zone, index) => ({
        ...zone,
        id: zone.name.toLowerCase().replace(/[^a-z0-9_]/g, '_') || 'zone_' + index
    }));
    
    const jsonStr = JSON.stringify(zonesToExport, null, 4);
    
    // Создаём файл для скачивания
    const blob = new Blob([jsonStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'world_zones.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    // Также выводим в консоль для копирования
    console.log('=== ЭКСПОРТ ЗОН (скопируй в map.js) ===');
    console.log(jsonStr);
    console.log('========================================');
    
    alert('Зоны экспортированы! Проверь консоль (F12) и скачанный файл.');
}

// ============================================
// РЕДАКТИРОВАНИЕ ЗОНЫ (МОДАЛЬНОЕ ОКНО)
// ============================================
let currentEditIndex = null;

function openZoneEditModal(index) {
    currentEditIndex = index;
    const zone = worldZones[index];
    
    document.getElementById('edit-zone-id').value = zone.id;
    document.getElementById('edit-zone-name').value = zone.name;
    document.getElementById('edit-zone-x').value = zone.x;
    document.getElementById('edit-zone-y').value = zone.y;
    document.getElementById('edit-zone-width').value = zone.width;
    document.getElementById('edit-zone-height').value = zone.height;
    document.getElementById('edit-zone-outdoor').value = zone.outdoor || '';
    
    document.getElementById('zone-edit-modal').style.display = 'block';
}

function closeZoneEditModal() {
    document.getElementById('zone-edit-modal').style.display = 'none';
    currentEditIndex = null;
}

function saveZoneEdit(e) {
    e.preventDefault();
    
    if (currentEditIndex === null) return;
    
    const zone = worldZones[currentEditIndex];
    zone.name = document.getElementById('edit-zone-name').value;
    zone.x = parseInt(document.getElementById('edit-zone-x').value);
    zone.y = parseInt(document.getElementById('edit-zone-y').value);
    zone.width = parseInt(document.getElementById('edit-zone-width').value);
    zone.height = parseInt(document.getElementById('edit-zone-height').value);
    zone.outdoor = document.getElementById('edit-zone-outdoor').value || null;
    
    // Генерируем id из названия
    zone.id = zone.name.toLowerCase().replace(/[^a-z0-9_]/g, '_');
    
    closeZoneEditModal();
    renderWorldZones();
}

function deleteZone() {
    if (currentEditIndex === null) return;
    
    if (confirm('Удалить эту зону?')) {
        worldZones.splice(currentEditIndex, 1);
        closeZoneEditModal();
        renderWorldZones();
    }
}

// Двойной клик по зоне для редактирования
document.getElementById('overlay-layer').addEventListener('dblclick', (e) => {
    if (!editorMode) return;
    
    const zoneEl = e.target.closest('.clickable-zone');
    if (zoneEl) {
        const index = parseInt(zoneEl.dataset.index);
        openZoneEditModal(index);
    }
});

// ============================================
// МЕТКИ: УПРАВЛЕНИЕ
// ============================================
function setupMarkerControls() {
    const toolbarHint = document.querySelector('#outdoor-toolbar .toolbar-hint');
    if (toolbarHint) {
        toolbarHint.textContent = 'Выберите тип метки для добавления';
    }

    document.getElementById('add-building-marker-btn').addEventListener('click', () => {
        setMarkerType('building');
    });

    document.getElementById('add-enemy-marker-btn').addEventListener('click', () => {
        setMarkerType('enemy');
    });

    document.getElementById('add-chest-marker-btn').addEventListener('click', () => {
        setMarkerType('chest');
    });

    document.getElementById('add-bed-marker-btn').addEventListener('click', () => {
        setMarkerType('bed');
    });

    document.getElementById('export-markers-btn').addEventListener('click', exportMarkers);

    // Клик по карте для установки метки
    document.getElementById('outdoor-map-container').addEventListener('click', onMapClickForMarker);
}

function setMarkerType(type) {
    markerEditMode = true;
    currentMarkerType = type;
    
    // Сбрасываем активный класс у всех кнопок
    document.querySelectorAll('.toolbar-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Добавляем активный класс нажатой кнопке
    const btnMap = {
        'building': 'add-building-marker-btn',
        'enemy': 'add-enemy-marker-btn',
        'chest': 'add-chest-marker-btn',
        'bed': 'add-bed-marker-btn'
    };

    document.getElementById(btnMap[type]).classList.add('active');
}

function getMarkerLabel(type) {
    const labels = {
        'building': 'Здание',
        'enemy': 'Враг',
        'chest': 'Сундук',
        'bed': 'Кровать'
    };
    return labels[type];
}

function onMapClickForMarker(e) {
    if (!markerEditMode || !currentMarkerType) return;
    
    const container = document.getElementById('outdoor-map-container');
    const rect = container.getBoundingClientRect();
    const img = document.getElementById('outdoor-map-image');
    
    if (!img) return;
    
    // Координаты относительно изображения, не контейнера
    const imgRect = img.getBoundingClientRect();
    const x = Math.round(e.clientX - imgRect.left);
    const y = Math.round(e.clientY - imgRect.top);
    
    // Проверка что клик внутри изображения
    if (x < 0 || y < 0 || x > img.width || y > img.height) {
        alert('Кликните по изображению карты');
        return;
    }
    
    const name = prompt(`Введите название для "${getMarkerLabel(currentMarkerType)}":`, getDefaultMarkerName(currentMarkerType));
    if (!name) return;
    
    let markerData = {
        x: x,
        y: y,
        name: name,
        map: currentOutdoorMap.outdoor
    };
    
    if (currentMarkerType === 'building') {
        const buildingId = prompt('Введите ID здания (например: tavern, church, department_store):', 'tavern');
        if (!buildingId) return;
        markerData.buildingId = buildingId;
    }
    
    // Добавляем в массив
    const arrayName = currentMarkerType + 's';
    if (!markersData[arrayName]) {
        markersData[arrayName] = [];
    }
    markersData[arrayName].push(markerData);
    
    // Перерисовываем метки
    renderOutdoorMarkers();

    // Сбрасываем режим
    markerEditMode = false;
    currentMarkerType = null;
    document.querySelectorAll('.toolbar-btn').forEach(btn => btn.classList.remove('active'));
}

function getDefaultMarkerName(type) {
    const defaults = {
        'building': 'Новое здание',
        'enemy': 'Враг',
        'chest': 'Сундук',
        'bed': 'Кровать'
    };
    return defaults[type];
}

function exportMarkers() {
    const jsonStr = JSON.stringify(markersData, null, 4);
    
    const blob = new Blob([jsonStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'markers.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    console.log('=== ЭКСПОРТ МЕТОК (скопируй в data/markers.json) ===');
    console.log(jsonStr);
    console.log('========================================');
    
    alert('Метки экспортированы! Проверь консоль (F12) и скачанный файл.');
}

// ============================================
// МОДАЛЬНЫЕ ОКНА КАРТ
// ============================================
function openOutdoorModal(zone) {
    if (editorMode) return; // В режиме редактора не открываем карты
    
    currentOutdoorMap = zone;
    const modal = document.getElementById('outdoor-modal');
    const title = document.getElementById('outdoor-title');
    const container = document.getElementById('outdoor-map-container');
    const toolbar = document.getElementById('outdoor-toolbar');

    title.textContent = zone.name || 'Локация';
    container.innerHTML = '';
    
    // Показываем панель инструментов
    toolbar.classList.remove('hidden');

    if (zone.outdoor) {
        const img = document.createElement('img');
        img.src = `maps_outdor/${zone.outdoor}`;
        img.alt = zone.name;
        img.id = 'outdoor-map-image';
        container.appendChild(img);

        setTimeout(() => renderOutdoorMarkers(), 100);
    } else if (zone.indoor) {
        openIndoorModal({ buildingId: 'sewers', name: zone.name });
        closeOutdoorModal();
        return;
    }

    modal.style.display = 'block';
}

function closeOutdoorModal() {
    const modal = document.getElementById('outdoor-modal');
    modal.style.display = 'none';
    currentOutdoorMap = null;
}

function renderOutdoorMarkers() {
    const markersLayer = document.getElementById('outdoor-markers-layer');
    const outdoorImg = document.getElementById('outdoor-map-image');
    if (!outdoorImg || !currentOutdoorMap) return;

    markersLayer.innerHTML = '';
    if (!markersData) return;

    const outdoorFileName = currentOutdoorMap.outdoor;

    // Враги
    markersData.enemies?.forEach(marker => {
        if (marker.map === outdoorFileName) {
            createMarkerInLayer(markersLayer, marker.x, marker.y, 'enemy', marker.name);
        }
    });

    // Сундуки
    markersData.chests?.forEach(marker => {
        if (marker.map === outdoorFileName) {
            createMarkerInLayer(markersLayer, marker.x, marker.y, 'chest', marker.name);
        }
    });

    // Кровати
    markersData.beds?.forEach(marker => {
        if (marker.map === outdoorFileName) {
            createMarkerInLayer(markersLayer, marker.x, marker.y, 'bed', marker.name);
        }
    });

    // Здания
    markersData.buildings?.forEach(marker => {
        if (marker.map === outdoorFileName) {
            const markerEl = createMarkerInLayer(markersLayer, marker.x, marker.y, 'building', marker.name);
            markerEl.addEventListener('click', (e) => {
                e.stopPropagation();
                openIndoorModal(marker);
            });
        }
    });
}

function createMarkerInLayer(layer, x, y, type, name) {
    const marker = document.createElement('div');
    marker.className = `map-marker ${type}`;
    marker.style.left = x + 'px';
    marker.style.top = y + 'px';

    marker.addEventListener('mouseenter', () => {
        const tooltip = document.createElement('div');
        tooltip.className = 'marker-tooltip';
        tooltip.textContent = name;
        marker.appendChild(tooltip);
    });

    marker.addEventListener('mouseleave', () => {
        const tooltip = marker.querySelector('.marker-tooltip');
        if (tooltip) tooltip.remove();
    });

    layer.appendChild(marker);
    return marker;
}

function openIndoorModal(buildingData) {
    const modal = document.getElementById('indoor-modal');
    const title = document.getElementById('indoor-title');
    const container = document.getElementById('indoor-maps-container');

    title.textContent = buildingData.name;
    container.innerHTML = '';

    let indoorMaps = [];

    if (buildingData.buildingId && buildings[buildingData.buildingId]) {
        indoorMaps = buildings[buildingData.buildingId].indoorMaps;
    } else if (buildingData.indoor) {
        indoorMaps = [buildingData.indoor];
    }

    indoorMaps.forEach((mapFile, index) => {
        const mapContainer = document.createElement('div');
        mapContainer.className = 'indoor-floor';

        const label = document.createElement('div');
        label.className = 'floor-label';
        label.textContent = `Этаж ${index + 1}`;

        const img = document.createElement('img');
        img.src = `maps_indoor/${mapFile}`;
        img.alt = `${buildingData.name} - Этаж ${index + 1}`;

        mapContainer.appendChild(label);
        mapContainer.appendChild(img);
        container.appendChild(mapContainer);
    });

    modal.style.display = 'block';
}

function closeIndoorModal() {
    const modal = document.getElementById('indoor-modal');
    modal.style.display = 'none';
}

// Закрытие по клику вне контента
window.addEventListener('click', (e) => {
    const outdoorModal = document.getElementById('outdoor-modal');
    const indoorModal = document.getElementById('indoor-modal');
    const zoneEditModal = document.getElementById('zone-edit-modal');

    if (e.target === outdoorModal) closeOutdoorModal();
    if (e.target === indoorModal) closeIndoorModal();
    if (e.target === zoneEditModal) closeZoneEditModal();
});

// Закрытие по Esc
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeOutdoorModal();
        closeIndoorModal();
        closeZoneEditModal();
    }
});
